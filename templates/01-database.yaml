{{- if .Values.database.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ .Values.database.name }}
  namespace: {{ include "ai-hub-manifest.targetNamespace" . }}
  labels:
    app.kubernetes.io/name: {{ .Values.database.name }}
    app.kubernetes.io/component: database
    {{- include "ai-hub-manifest.labels" . | nindent 4 }}
spec:
  instances: {{ .Values.database.instances }}
  imageName: {{ .Values.database.imageName }}
  bootstrap:
    initdb:
      database: {{ .Values.database.initdb.database }}
      owner: {{ .Values.database.initdb.owner }}
  storage:
    size: {{ .Values.database.storage.size }}
{{- if .Values.database.monitoring.enabled }}
  monitoring:
    enablePodMonitor: true  # CNPG 오퍼레이터가 PodMonitor를 자동 생성
{{- end }}
{{- if and .Values.database.monitoring.enabled .Values.database.monitoring.istio.enabled .Values.database.monitoring.istio.excludeMetricsPort }}
  # Istio mTLS 환경에서 메트릭 수집을 위한 Pod annotation 설정
  managed:
    podAnnotation:
      traffic.sidecar.istio.io/excludeInboundPorts: "9187"  # CloudNative-PG metrics port
{{- end }}
{{- if .Values.database.backup.enabled }}
  backup:
    retentionPolicy: {{ .Values.database.backup.retentionPolicy }}
    barmanObjectStore:
      serverName: {{ .Values.database.name }}
      destinationPath: s3://{{ .Values.database.backup.r2.bucketName }}/
      endpointURL: {{ .Values.database.backup.r2.endpoint }}
      s3Credentials:
        accessKeyId:
          name: {{ .Values.database.backup.r2.existingSecretName }}
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: {{ .Values.database.backup.r2.existingSecretName }}
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
{{- end }}

{{- if .Values.database.backup.enabled }}
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: {{ .Values.database.name }}-daily-backup
  namespace: {{ include "ai-hub-manifest.targetNamespace" . }}
spec:
  schedule: "0 0 21 * * *"
  immediate: true
  cluster:
    name: {{ .Values.database.name }}
{{- end }}

{{- end }}